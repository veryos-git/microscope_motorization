<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stepper Control</title>
<!--ESP_IP_INJECT-->
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;600;700&display=swap');

  :root {
    --bg:       #0a0a0c;
    --surface:  #141418;
    --border:   #2a2a32;
    --text:     #e8e8ec;
    --dim:      #6e6e7a;
    --accent-0: #ff6b35;
    --accent-1: #00d4aa;
    --accent-2: #5b8def;
    --danger:   #ff4757;
    --yellow:   #ffc312;
    --radius:   10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Space Grotesk', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 24px;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
  }
  header h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }

  .header-right { display: flex; align-items: center; gap: 12px; }

  .conn-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    display: flex; align-items: center; gap: 6px;
  }
  .conn-badge .dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger); transition: background 0.3s;
  }
  .conn-badge.connected .dot { background: var(--accent-1); }

  /* IP bar */
  .ip-bar {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 24px; padding: 12px 16px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  }
  .ip-bar label {
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--dim); white-space: nowrap;
  }
  .ip-bar input {
    flex: 1; max-width: 220px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 12px; color: var(--text);
    font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; outline: none;
  }
  .ip-bar input:focus { border-color: var(--accent-2); }
  .ip-bar button {
    padding: 8px 16px; background: var(--accent-2); color: var(--bg); border: none;
    border-radius: 6px; font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s;
  }
  .ip-bar button:hover { opacity: 0.85; }

  /* ─── WASD Panel ─── */
  .keybind-panel {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden;
  }
  .keybind-panel::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: var(--yellow);
  }

  .keybind-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; flex-wrap: wrap; gap: 8px;
  }
  .keybind-header h2 { font-size: 1.1rem; font-weight: 600; }
  .keybind-header .hint {
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--dim);
    background: var(--bg); padding: 3px 8px; border-radius: 4px;
  }

  .keybind-body {
    display: flex; gap: 32px; align-items: flex-start; flex-wrap: wrap;
  }

  /* WASD visual */
  .wasd-visual {
    display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0;
  }
  .wasd-row { display: flex; gap: 4px; }

  .key-cap {
    width: 56px; height: 56px;
    background: var(--bg); border: 2px solid var(--border); border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700;
    color: var(--dim); transition: all 0.1s; user-select: none; cursor: default;
  }
  .key-cap.pressed {
    border-color: var(--yellow); color: var(--yellow);
    background: color-mix(in srgb, var(--yellow) 10%, var(--bg));
    box-shadow: 0 0 12px color-mix(in srgb, var(--yellow) 25%, transparent);
    transform: scale(0.95);
  }
  .key-spacer { width: 56px; height: 56px; }

  /* Jog speed */
  .jog-speed-group {
    display: flex; flex-direction: column; gap: 8px; min-width: 120px;
  }
  .jog-speed-group label {
    font-size: 0.8rem; color: var(--dim); text-transform: uppercase;
    letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
    display: flex; justify-content: space-between;
  }
  .jog-speed-group .speed-value {
    color: var(--text); font-weight: 700;
  }
  .jog-speed-group input[type="range"] {
    --card-accent: var(--yellow);
  }

  /* Mapping table */
  .mapping-grid {
    flex: 1; min-width: 280px;
  }
  .mapping-row {
    display: grid; grid-template-columns: 48px 1fr 1fr; gap: 8px;
    align-items: center; margin-bottom: 8px;
  }
  .mapping-row.header {
    margin-bottom: 12px;
  }
  .mapping-row.header span {
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
    color: var(--dim); text-transform: uppercase; letter-spacing: 1px;
  }

  .key-label {
    font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
    font-weight: 700; color: var(--yellow); text-align: center;
  }

  .mapping-row select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 10px; color: var(--text);
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
    outline: none; cursor: pointer; appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236e6e7a'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }
  .mapping-row select:focus { border-color: var(--yellow); }
  .mapping-row select option { background: var(--bg); color: var(--text); }

  /* ─── Motor cards ─── */
  .motors-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px; margin-bottom: 24px;
  }

  .motor-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px;
    position: relative; overflow: hidden; transition: border-color 0.3s;
  }
  .motor-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .motor-card:nth-child(1)::before { background: var(--accent-0); }
  .motor-card:nth-child(2)::before { background: var(--accent-1); }
  .motor-card:nth-child(3)::before { background: var(--accent-2); }
  .motor-card:nth-child(1) { --card-accent: var(--accent-0); }
  .motor-card:nth-child(2) { --card-accent: var(--accent-1); }
  .motor-card:nth-child(3) { --card-accent: var(--accent-2); }

  .card-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
  }
  .card-header h2 { font-size: 1.1rem; font-weight: 600; }
  .motor-id {
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--dim);
    background: var(--bg); padding: 3px 8px; border-radius: 4px;
  }

  .position-display {
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
    color: var(--dim); margin-bottom: 20px;
  }

  .control-group { margin-bottom: 18px; }
  .control-group label {
    display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--dim);
    margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
  }
  .speed-value {
    color: var(--text); font-family: 'JetBrains Mono', monospace; font-weight: 700;
  }

  input[type="range"] {
    -webkit-appearance: none; appearance: none; width: 100%; height: 6px;
    background: var(--bg); border-radius: 3px; outline: none; cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
    background: var(--card-accent); cursor: pointer;
    box-shadow: 0 0 10px color-mix(in srgb, var(--card-accent) 40%, transparent);
  }
  input[type="range"]::-moz-range-thumb {
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--card-accent); border: none; cursor: pointer;
  }

  .dir-toggle {
    display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);
  }
  .dir-btn {
    flex: 1; padding: 10px; background: var(--bg); color: var(--dim); border: none;
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .dir-btn.active { background: var(--card-accent); color: var(--bg); font-weight: 700; }
  .dir-btn:hover:not(.active) { background: var(--border); color: var(--text); }

  .stop-btn {
    width: 100%; padding: 10px; margin-top: 16px; background: transparent;
    color: var(--danger); border: 1px solid var(--danger); border-radius: 6px;
    font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700;
    cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
  }
  .stop-btn:hover { background: var(--danger); color: var(--bg); }

  .global-bar { display: flex; gap: 12px; }
  .global-btn {
    flex: 1; padding: 14px; border-radius: var(--radius); border: 1px solid var(--border);
    background: var(--surface); color: var(--text);
    font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700;
    cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
  }
  .global-btn:hover { border-color: var(--text); }
  .global-btn.stop-all { border-color: var(--danger); color: var(--danger); }
  .global-btn.stop-all:hover { background: var(--danger); color: var(--bg); }

  /* ─── Minimap ─── */
  .minimap-panel {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 0; margin-bottom: 24px; position: relative; overflow: hidden;
  }
  .minimap-panel::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: var(--accent-1); z-index: 1;
  }
  .minimap-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px 0; flex-wrap: wrap; gap: 8px;
  }
  .minimap-header h2 { font-size: 1.1rem; font-weight: 600; }
  .minimap-header button {
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--dim);
    background: var(--bg); padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border);
    cursor: pointer; transition: color 0.2s;
  }
  .minimap-header button:hover { color: var(--text); }
  .minimap-canvas-wrap {
    padding: 12px; padding-top: 8px;
  }
  .minimap-canvas-wrap canvas {
    width: 100%; height: 260px; display: block; border-radius: 6px;
  }

  @media (max-width: 480px) {
    body { padding: 16px; }
    header h1 { font-size: 1.2rem; }
    .ip-bar { flex-wrap: wrap; }
    .ip-bar input { max-width: 100%; }
    .keybind-body { flex-direction: column; }
  }
</style>
</head>
<body>

<header>
  <h1>&#9881; Stepper Control</h1>
  <div class="header-right">
    <div class="conn-badge" id="connBadge">
      <span class="dot"></span>
      <span id="connText">disconnected</span>
    </div>
  </div>
</header>

<div class="ip-bar" id="ipBar">
  <label>ESP32 IP</label>
  <input type="text" id="espIpInput" placeholder="192.168.1.100">
  <button onclick="connectToEsp()">Connect</button>
</div>

<!-- WASD Key Binding Panel -->
<div class="keybind-panel">
  <div class="keybind-header">
    <h2>&#9000; Keyboard Jog</h2>
    <span class="hint">hold key = move &middot; release = stop</span>
  </div>

  <div class="keybind-body">
    <!-- WASD visual -->
    <div>
      <div class="wasd-visual">
        <div class="wasd-row">
          <div class="key-spacer"></div>
          <div class="key-cap" id="keyW">W</div>
          <div class="key-spacer"></div>
        </div>
        <div class="wasd-row">
          <div class="key-cap" id="keyA">A</div>
          <div class="key-cap" id="keyS">S</div>
          <div class="key-cap" id="keyD">D</div>
        </div>
      </div>

      <div class="jog-speed-group" style="margin-top: 16px;">
        <label>Jog Speed <span class="speed-value" id="jogSpeedVal">50%</span></label>
        <input type="range" id="jogSpeed" min="1" max="100" value="50"
               oninput="document.getElementById('jogSpeedVal').textContent = this.value + '%'">
      </div>
    </div>

    <!-- Mapping config -->
    <div class="mapping-grid">
      <div class="mapping-row header">
        <span>Key</span>
        <span>Motor</span>
        <span>Direction</span>
      </div>
      <div class="mapping-row" id="mapW">
        <span class="key-label">W</span>
        <select id="mapW_motor">
          <option value="none">— none —</option>
          <option value="0">Motor A (M0)</option>
          <option value="1" selected>Motor B (M1)</option>
          <option value="2">Motor C (M2)</option>
        </select>
        <select id="mapW_dir">
          <option value="cw" selected>CW &#8635;</option>
          <option value="ccw">CCW &#8634;</option>
        </select>
      </div>
      <div class="mapping-row" id="mapS">
        <span class="key-label">S</span>
        <select id="mapS_motor">
          <option value="none">— none —</option>
          <option value="0">Motor A (M0)</option>
          <option value="1" selected>Motor B (M1)</option>
          <option value="2">Motor C (M2)</option>
        </select>
        <select id="mapS_dir">
          <option value="cw">CW &#8635;</option>
          <option value="ccw" selected>CCW &#8634;</option>
        </select>
      </div>
      <div class="mapping-row" id="mapA">
        <span class="key-label">A</span>
        <select id="mapA_motor">
          <option value="none">— none —</option>
          <option value="0" selected>Motor A (M0)</option>
          <option value="1">Motor B (M1)</option>
          <option value="2">Motor C (M2)</option>
        </select>
        <select id="mapA_dir">
          <option value="cw">CW &#8635;</option>
          <option value="ccw" selected>CCW &#8634;</option>
        </select>
      </div>
      <div class="mapping-row" id="mapD">
        <span class="key-label">D</span>
        <select id="mapD_motor">
          <option value="none">— none —</option>
          <option value="0" selected>Motor A (M0)</option>
          <option value="1">Motor B (M1)</option>
          <option value="2">Motor C (M2)</option>
        </select>
        <select id="mapD_dir">
          <option value="cw" selected>CW &#8635;</option>
          <option value="ccw">CCW &#8634;</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Minimap -->
<div class="minimap-panel">
  <div class="minimap-header">
    <h2>&#9678; Minimap</h2>
    <button onclick="minimap.clear()">Clear trace</button>
  </div>
  <div class="minimap-canvas-wrap">
    <canvas id="minimapCanvas"></canvas>
  </div>
</div>

<div class="motors-grid" id="motorsGrid"></div>

<div class="global-bar">
  <button class="global-btn stop-all" onclick="sendStopAll()">&#9632; Stop All</button>
  <button class="global-btn" onclick="requestStatus()">&#8635; Refresh</button>
</div>

<script src="minimap.js"></script>
<script src="index.js"></script>
</body>
</html>
